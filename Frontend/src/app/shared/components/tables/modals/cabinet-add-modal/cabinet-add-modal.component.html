<app-modal
  [isOpen]="isAddModalOpen"
  (close)="closeAddModal()"
  className="max-w-[700px] m-4"
>
  <div class="no-scrollbar relative w-full max-w-[700px] overflow-y-auto rounded-3xl bg-white p-4 dark:bg-gray-900 lg:p-11">
    <div class="px-2 pr-14">
      <h4 class="mb-2 text-2xl font-semibold text-gray-800 dark:text-white/90">
        Nouveau Cabinet & Médecin
      </h4>
      <p class="mb-4 text-sm text-gray-500 dark:text-gray-400">
        Créez un cabinet médical avec son médecin responsable.
      </p>

      <!-- Indicateur d'étapes -->
      <div class="flex items-center justify-center gap-4 mb-6">
        <div class="flex items-center gap-2">
          <div 
            class="flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium"
            [ngClass]="currentStep === 1 ? 'bg-green-600 text-white' : 'bg-green-100 text-green-600 dark:bg-green-900/30'"
          >
            1
          </div>
          <span class="text-sm" [ngClass]="currentStep === 1 ? 'text-gray-800 dark:text-white font-medium' : 'text-gray-500'">
            Cabinet
          </span>
        </div>
        <div class="w-12 h-0.5 bg-gray-300 dark:bg-gray-700"></div>
        <div class="flex items-center gap-2">
          <div 
            class="flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium"
            [ngClass]="currentStep === 2 ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-500 dark:bg-gray-700'"
          >
            2
          </div>
          <span class="text-sm" [ngClass]="currentStep === 2 ? 'text-gray-800 dark:text-white font-medium' : 'text-gray-500'">
            Médecin
          </span>
        </div>
      </div>
    </div>

    <!-- Message d'erreur -->
    <div *ngIf="errorMessage" class="mx-2 mb-4 rounded-lg bg-red-50 p-4 text-sm text-red-800 dark:bg-red-900/20 dark:text-red-400">
      {{ errorMessage }}
    </div>

    <form class="flex flex-col" (ngSubmit)="currentStep === 1 ? nextStep() : handleSave()">
      <div class="custom-scrollbar h-[420px] overflow-y-auto px-2 pb-3">
        
        <!-- ÉTAPE 1: CABINET -->
        <div *ngIf="currentStep === 1">
          <h5 class="mb-5 text-lg font-medium text-gray-800 dark:text-white/90 lg:mb-6 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 21h18M5 21V7l8-4v18M19 21V11l-6-4M9 9v.01M9 12v.01M9 15v.01M9 18v.01"/>
            </svg>
            Informations du cabinet
          </h5>
          
          <!-- Logo du cabinet -->
          <div class="flex justify-center mb-6">
            <div class="relative w-20 h-20">
              <img
                [src]="previewLogoUrl"
                alt="Logo"
                class="w-full h-full rounded-xl object-cover border-2 border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800"
              />
              <label
                for="logoUpload"
                class="absolute bottom-0 right-0 flex h-7 w-7 cursor-pointer items-center justify-center rounded-full bg-green-600 text-white shadow hover:bg-green-700"
              >
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-3.5 w-3.5">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
              </label>
              <input id="logoUpload" type="file" accept="image/*" class="hidden" (change)="onLogoChange($event)"/>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-x-6 gap-y-4 lg:grid-cols-2">
            <div class="col-span-2">
              <app-label>Nom du cabinet *</app-label>
              <input
                type="text"
                [(ngModel)]="cabinet.nom"
                name="nom"
                placeholder="Cabinet médical Dr. ..."
                class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 
                       focus:border-brand-300 focus:outline-none focus:ring-2 focus:ring-brand-500/10
                       dark:border-gray-700 dark:text-white/90 dark:focus:border-brand-800 placeholder-gray-300 dark:placeholder-gray-500"
                required
              />
            </div>

            <div class="col-span-2 lg:col-span-1">
              <app-label>Spécialité</app-label>
              <input
                type="text"
                [(ngModel)]="cabinet.specialite"
                name="specialite"
                placeholder="Médecine générale, Cardiologie..."
                class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 
                       focus:border-brand-300 focus:outline-none focus:ring-2 focus:ring-brand-500/10
                       dark:border-gray-700 dark:text-white/90 dark:focus:border-brand-800 placeholder-gray-300 dark:placeholder-gray-500"
              />
            </div>

            <div class="col-span-2 lg:col-span-1">
              <app-label>Téléphone cabinet</app-label>
              <input
                type="tel"
                [(ngModel)]="cabinet.tel"
                name="tel"
                placeholder="05XXXXXXXX"
                class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 
                       focus:border-brand-300 focus:outline-none focus:ring-2 focus:ring-brand-500/10
                       dark:border-gray-700 dark:text-white/90 dark:focus:border-brand-800 placeholder-gray-300 dark:placeholder-gray-500"
              />
            </div>

            <div class="col-span-2">
              <app-label>Adresse</app-label>
              <input
                type="text"
                [(ngModel)]="cabinet.adresse"
                name="adresse"
                placeholder="Adresse complète du cabinet"
                class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 
                       focus:border-brand-300 focus:outline-none focus:ring-2 focus:ring-brand-500/10
                       dark:border-gray-700 dark:text-white/90 dark:focus:border-brand-800 placeholder-gray-300 dark:placeholder-gray-500"
              />
            </div>

            <div class="col-span-2">
              <app-label>Date d'expiration du service</app-label>
              <input
                type="date"
                [(ngModel)]="cabinet.date_expiration_service"
                name="date_expiration_service"
                class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 
                       focus:border-brand-300 focus:outline-none focus:ring-2 focus:ring-brand-500/10
                       dark:border-gray-700 dark:text-white/90 dark:focus:border-brand-800"
              />
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                Laissez vide si pas d'expiration définie
              </p>
            </div>
          </div>
        </div>

        <!-- ÉTAPE 2: MÉDECIN -->
        <div *ngIf="currentStep === 2">
          <h5 class="mb-5 text-lg font-medium text-gray-800 dark:text-white/90 lg:mb-6 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            Informations du médecin responsable
          </h5>

          <!-- Récapitulatif cabinet -->
          <div class="mb-6 p-3 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800">
            <div class="flex items-center gap-3">
              <img [src]="previewLogoUrl" alt="Logo" class="w-10 h-10 rounded-lg object-cover"/>
              <div>
                <p class="text-sm font-medium text-green-800 dark:text-green-300">{{ cabinet.nom }}</p>
                <p class="text-xs text-green-600 dark:text-green-400">{{ cabinet.specialite || 'Spécialité non définie' }}</p>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-x-6 gap-y-4 lg:grid-cols-2">
            <div class="col-span-2 lg:col-span-1">
              <app-label>Prénom *</app-label>
              <input
                type="text"
                [(ngModel)]="medecin.prenom"
                name="medecinPrenom"
                placeholder="Prénom du médecin"
                class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 
                       focus:border-brand-300 focus:outline-none focus:ring-2 focus:ring-brand-500/10
                       dark:border-gray-700 dark:text-white/90 dark:focus:border-brand-800 placeholder-gray-300 dark:placeholder-gray-500"
                required
              />
            </div>

            <div class="col-span-2 lg:col-span-1">
              <app-label>Nom *</app-label>
              <input
                type="text"
                [(ngModel)]="medecin.nom"
                name="medecinNom"
                placeholder="Nom du médecin"
                class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 
                       focus:border-brand-300 focus:outline-none focus:ring-2 focus:ring-brand-500/10
                       dark:border-gray-700 dark:text-white/90 dark:focus:border-brand-800 placeholder-gray-300 dark:placeholder-gray-500"
                required
              />
            </div>

            <div class="col-span-2">
              <app-label>Email (identifiant de connexion) *</app-label>
              <input
                type="email"
                [(ngModel)]="medecin.username"
                name="medecinUsername"
                placeholder="medecin@example.com"
                class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 
                       focus:border-brand-300 focus:outline-none focus:ring-2 focus:ring-brand-500/10
                       dark:border-gray-700 dark:text-white/90 dark:focus:border-brand-800 placeholder-gray-300 dark:placeholder-gray-500"
                required
              />
            </div>

            <div class="col-span-2">
              <app-label>Mot de passe *</app-label>
              <div class="flex gap-2">
                <input
                  type="text"
                  [(ngModel)]="medecin.password"
                  name="medecinPassword"
                  placeholder="Mot de passe (min. 6 caractères)"
                  class="flex-1 rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 
                         focus:border-brand-300 focus:outline-none focus:ring-2 focus:ring-brand-500/10
                         dark:border-gray-700 dark:text-white/90 dark:focus:border-brand-800 placeholder-gray-300 dark:placeholder-gray-500"
                  required
                />
                <button
                  type="button"
                  (click)="generatePassword()"
                  class="px-3 py-2 rounded-lg border border-gray-300 bg-gray-50 text-gray-600 text-xs font-medium hover:bg-gray-100 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700"
                >
                  Générer
                </button>
              </div>
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                Notez ce mot de passe, il sera envoyé au médecin
              </p>
            </div>

            <div class="col-span-2 lg:col-span-1">
              <app-label>Téléphone</app-label>
              <input
                type="tel"
                [(ngModel)]="medecin.numTel"
                name="medecinNumTel"
                placeholder="06XXXXXXXX"
                class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 
                       focus:border-brand-300 focus:outline-none focus:ring-2 focus:ring-brand-500/10
                       dark:border-gray-700 dark:text-white/90 dark:focus:border-brand-800 placeholder-gray-300 dark:placeholder-gray-500"
              />
            </div>

            <div class="col-span-2 lg:col-span-1">
              <app-label>Signature (optionnel)</app-label>
              <input
                type="text"
                [(ngModel)]="medecin.signature"
                name="medecinSignature"
                placeholder="Dr. Nom Prénom"
                class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 
                       focus:border-brand-300 focus:outline-none focus:ring-2 focus:ring-brand-500/10
                       dark:border-gray-700 dark:text-white/90 dark:focus:border-brand-800 placeholder-gray-300 dark:placeholder-gray-500"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- Boutons d'action -->
      <div class="flex items-center gap-3 px-2 mt-6" [ngClass]="currentStep === 1 ? 'lg:justify-end' : 'justify-between'">
        <!-- Bouton Retour (étape 2) -->
        <button 
          *ngIf="currentStep === 2"
          type="button"
          (click)="previousStep()"
          class="inline-flex items-center gap-2 px-4 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Retour
        </button>

        <div class="flex items-center gap-3">
          <app-button 
            size="sm" 
            variant="outline" 
            type="button"
            (btnClick)="closeAddModal()"
          >
            Annuler
          </app-button>
          
          <!-- Bouton Suivant (étape 1) -->
          <button 
            *ngIf="currentStep === 1"
            type="submit"
            class="inline-flex items-center justify-center gap-2 rounded-lg bg-green-700 px-4 py-2.5 text-sm font-medium text-white shadow-sm hover:bg-green-800"
          >
            Suivant
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </button>

          <!-- Bouton Créer (étape 2) -->
          <button 
            *ngIf="currentStep === 2"
            type="submit"
            [disabled]="isLoading"
            class="inline-flex items-center justify-center gap-2 rounded-lg bg-green-700 px-4 py-2.5 text-sm font-medium text-white shadow-sm hover:bg-green-800 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span *ngIf="!isLoading">Créer le cabinet et le médecin</span>
            <span *ngIf="isLoading">Création en cours...</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</app-modal>
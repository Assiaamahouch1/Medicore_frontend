<div class="p-5 lg:p-6">
  <!-- Loading state -->
  @if (loading) {
    <div class="flex flex-col items-center justify-center h-96">
      <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-500 border-t-transparent mb-4"></div>
      <p class="text-gray-500 dark:text-gray-400 text-sm">Chargement des données...</p>
    </div>
  } @else if (error) {
    <!-- Error state -->
    <div class="flex flex-col items-center justify-center h-96">
      <div class="rounded-full bg-red-100 dark:bg-red-500/20 p-4 mb-4">
        <svg class="h-12 w-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      <h3 class="text-xl font-semibold text-gray-800 dark:text-white/90 mb-2">Erreur de chargement</h3>
      <p class="text-gray-500 dark:text-gray-400 text-center max-w-md">{{ error }}</p>
      <button 
        (click)="refresh()" 
        class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
        Réessayer
      </button>
    </div>
  } @else {
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-800 dark:text-white/90">
            Tableau de Bord SuperAdministrateur
          </h1>
          <p class="text-gray-500 dark:text-gray-400 mt-2">
            Gestion et statistiques des cabinets médicaux
          </p>
        </div>
        <div class="flex items-center gap-3">
          <button 
            (click)="refresh()" 
            [disabled]="loading"
            class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50">
            <svg class="h-5 w-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            <span class="text-sm font-medium text-gray-700">Actualiser</span>
          </button>
          <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <span>{{ today | date:'fullDate' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- KPI Cards Grid - Principales statistiques -->
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-5 mb-6">
      
      <!-- Card 1: Total Cabinets -->
      <div class="rounded-2xl border border-gray-200 bg-white p-6 dark:border-white/[0.05] dark:bg-white/[0.03] shadow-sm hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between mb-4">
          <div class="flex h-14 w-14 items-center justify-center rounded-xl bg-blue-50 dark:bg-blue-500/[0.12]">
            <svg class="h-7 w-7 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
          </div>
        </div>
        <div>
          <h4 class="text-3xl font-bold text-gray-800 dark:text-white/90 mb-1">
            {{ stats?.totalCabinets ?? 0 }}
          </h4>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            Total Cabinets
          </p>
        </div>
      </div>

      <!-- Card 2: Cabinets Actifs -->
      <div class="rounded-2xl border border-gray-200 bg-white p-6 dark:border-white/[0.05] dark:bg-white/[0.03] shadow-sm hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between mb-4">
          <div class="flex h-14 w-14 items-center justify-center rounded-xl bg-green-50 dark:bg-green-500/[0.12]">
            <svg class="h-7 w-7 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <span class="flex items-center gap-1 rounded-full bg-green-50 px-3 py-1 text-xs font-medium text-green-600 dark:bg-green-500/[0.12] dark:text-green-400">
            <span class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></span>
            Actifs
          </span>
        </div>
        <div>
          <h4 class="text-3xl font-bold text-gray-800 dark:text-white/90 mb-1">
            {{ stats?.cabinetsActifs ?? 0 }}
          </h4>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            Cabinets actifs
          </p>
          @if (stats && stats.totalCabinets > 0) {
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
              {{ getActivePercentage().toFixed(1) }}% du total
            </p>
          }
        </div>
      </div>

      <!-- Card 3: Cabinets Inactifs -->
      <div class="rounded-2xl border border-gray-200 bg-white p-6 dark:border-white/[0.05] dark:bg-white/[0.03] shadow-sm hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between mb-4">
          <div class="flex h-14 w-14 items-center justify-center rounded-xl bg-gray-50 dark:bg-gray-500/[0.12]">
            <svg class="h-7 w-7 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
        </div>
        <div>
          <h4 class="text-3xl font-bold text-gray-800 dark:text-white/90 mb-1">
            {{ stats?.cabinetsInactifs ?? 0 }}
          </h4>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            Cabinets inactifs
          </p>
          @if (stats && stats.totalCabinets > 0) {
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
              {{ getInactivePercentage().toFixed(1) }}% du total
            </p>
          }
        </div>
      </div>

      <!-- Card 4: Expirent Bientôt -->
      <div class="rounded-2xl border border-gray-200 bg-white p-6 dark:border-white/[0.05] dark:bg-white/[0.03] shadow-sm hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between mb-4">
          <div class="flex h-14 w-14 items-center justify-center rounded-xl bg-yellow-50 dark:bg-yellow-500/[0.12]">
            <svg class="h-7 w-7 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          @if (stats && stats.cabinetsExpirantBientot > 0) {
            <span class="flex items-center gap-1 rounded-full bg-yellow-50 px-3 py-1 text-xs font-medium text-yellow-600 dark:bg-yellow-500/[0.12] dark:text-yellow-400">
              Attention
            </span>
          }
        </div>
        <div>
          <h4 class="text-3xl font-bold text-gray-800 dark:text-white/90 mb-1">
            {{ stats?.cabinetsExpirantBientot ?? 0 }}
          </h4>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            Expirent bientôt
          </p>
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
            Dans 7 jours
          </p>
        </div>
      </div>

      <!-- Card 5: Cabinets Expirés -->
      <div class="rounded-2xl border border-gray-200 bg-white p-6 dark:border-white/[0.05] dark:bg-white/[0.03] shadow-sm hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between mb-4">
          <div class="flex h-14 w-14 items-center justify-center rounded-xl bg-red-50 dark:bg-red-500/[0.12]">
            <svg class="h-7 w-7 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          @if (stats && stats.cabinetsExpires > 0) {
            <span class="flex items-center gap-1 rounded-full bg-red-50 px-3 py-1 text-xs font-medium text-red-600 dark:bg-red-500/[0.12] dark:text-red-400">
              Urgent
            </span>
          }
        </div>
        <div>
          <h4 class="text-3xl font-bold text-gray-800 dark:text-white/90 mb-1">
            {{ stats?.cabinetsExpires ?? 0 }}
          </h4>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            Cabinets expirés
          </p>
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
            Action requise
          </p>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2 mb-6">
      <!-- Graphique Donut: Répartition par Spécialité -->
      <div class="rounded-2xl border border-gray-200 bg-white dark:border-white/[0.05] dark:bg-white/[0.03] shadow-sm">
        <div class="border-b border-gray-200 px-6 py-4 dark:border-white/[0.05]">
          <div>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">
              Répartition par Spécialité
            </h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
              Distribution des cabinets
            </p>
          </div>
        </div>
        <div class="p-6">
          @if (getPieChartData().length > 0) {
            <div class="flex flex-col lg:flex-row items-center gap-6">
              <!-- Graphique SVG Donut -->
              <div class="flex-shrink-0">
                <svg width="200" height="200" viewBox="0 0 200 200" class="transform -rotate-90">
                  @for (item of getPieChartData(); track item.label; let i = $index) {
                    <path
                      [attr.d]="getDonutChartPath(i, getPieChartData().length)"
                      [attr.fill]="item.color"
                      [attr.stroke]="'white'"
                      [attr.stroke-width]="3"
                      class="transition-all duration-500 hover:opacity-80 cursor-pointer"
                      [attr.data-label]="item.label"
                      [attr.data-value]="item.value"
                    />
                  }
                  <!-- Cercle intérieur pour effet donut -->
                  <circle cx="100" cy="100" r="50" fill="white" />
                  <text x="100" y="100" text-anchor="middle" dominant-baseline="middle" 
                        class="fill-gray-800 dark:fill-white text-2xl font-bold transform rotate-90"
                        style="transform-origin: 100px 100px;">
                    {{ stats?.totalCabinets ?? 0 }}
                  </text>
                  <text x="100" y="120" text-anchor="middle" dominant-baseline="middle" 
                        class="fill-gray-500 dark:fill-gray-400 text-xs transform rotate-90"
                        style="transform-origin: 100px 100px;">
                    Total
                  </text>
                </svg>
              </div>
              
              <!-- Légende -->
              <div class="flex-1 space-y-3 min-w-0">
                @for (item of getPieChartData(); track item.label) {
                  <div class="flex items-center gap-3">
                    <div 
                      class="h-4 w-4 rounded flex-shrink-0"
                      [style.background-color]="item.color">
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700 dark:text-white/90 truncate">
                          {{ item.label }}
                        </span>
                        <span class="text-sm font-bold text-gray-800 dark:text-white/90 ml-2">
                          {{ item.value }}
                        </span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1 dark:bg-gray-700">
                        <div 
                          class="h-1.5 rounded-full transition-all duration-500"
                          [style.width.%]="item.percentage"
                          [style.background-color]="item.color">
                        </div>
                      </div>
                      <span class="text-xs text-gray-500 dark:text-gray-400">
                        {{ item.percentage.toFixed(1) }}%
                      </span>
                    </div>
                  </div>
                }
              </div>
            </div>
          } @else {
            <div class="flex items-center justify-center h-64 text-gray-400">
              <p class="text-sm">Aucune spécialité enregistrée</p>
            </div>
          }
        </div>
      </div>

      <!-- Vue d'Ensemble -->
      <div class="rounded-2xl border border-gray-200 bg-white dark:border-white/[0.05] dark:bg-white/[0.03] shadow-sm">
        <div class="border-b border-gray-200 px-6 py-4 dark:border-white/[0.05]">
          <div>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">
              Vue d'Ensemble
            </h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
              Statut des cabinets
            </p>
          </div>
        </div>
        <div class="p-6">
          <div class="space-y-4">
            <!-- Actifs -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <div class="h-3 w-3 rounded-full bg-green-500"></div>
                  <span class="text-sm font-medium text-gray-700 dark:text-white/90">Actifs</span>
                </div>
                <span class="text-sm font-bold text-gray-800 dark:text-white/90">{{ stats?.cabinetsActifs ?? 0 }}</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-700">
                <div 
                  class="h-3 rounded-full bg-gradient-to-r from-green-500 to-green-600 transition-all duration-500"
                  [style.width.%]="stats && stats.totalCabinets > 0 ? (stats.cabinetsActifs / stats.totalCabinets * 100) : 0"
                ></div>
              </div>
            </div>

            <!-- Inactifs -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <div class="h-3 w-3 rounded-full bg-gray-500"></div>
                  <span class="text-sm font-medium text-gray-700 dark:text-white/90">Inactifs</span>
                </div>
                <span class="text-sm font-bold text-gray-800 dark:text-white/90">{{ stats?.cabinetsInactifs ?? 0 }}</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-700">
                <div 
                  class="h-3 rounded-full bg-gradient-to-r from-gray-500 to-gray-600 transition-all duration-500"
                  [style.width.%]="stats && stats.totalCabinets > 0 ? (stats.cabinetsInactifs / stats.totalCabinets * 100) : 0"
                ></div>
              </div>
            </div>

            <!-- Expirés -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <div class="h-3 w-3 rounded-full bg-red-500"></div>
                  <span class="text-sm font-medium text-gray-700 dark:text-white/90">Expirés</span>
                </div>
                <span class="text-sm font-bold text-gray-800 dark:text-white/90">{{ stats?.cabinetsExpires ?? 0 }}</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-700">
                <div 
                  class="h-3 rounded-full bg-gradient-to-r from-red-500 to-red-600 transition-all duration-500"
                  [style.width.%]="stats && stats.totalCabinets > 0 ? (stats.cabinetsExpires / stats.totalCabinets * 100) : 0"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

   
  }
</div>
